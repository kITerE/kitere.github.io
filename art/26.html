<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251" />
<script type="text/javascript" src="../js/ppm.js"></script>
<title>EreTIk's Box &raquo; Рассылка IRP о завершении работы системы (IRP_MJ_SHUTDOWN)</title>
<meta name="keywords" content="EreTIk, kernel, ring0, driver, SHUTDOWN_PACKET, _SHUTDOWN_PACKET, IRP_MJ_SHUTDOWN, CmShutdownSystem, HvShutdownComplete, IoShutdownSystem, STATUS_TOO_LATE, IopDiskFileSystemQueueHead, IopCdRomFileSystemQueueHead, IopTapeFileSystemQueueHead, IoRegisterShutdownNotification, IoRegisterLastChanceShutdownNotification" />
<link rel="stylesheet" type="text/css" href="../style.css" />
<link rel="alternate" type="application/rss+xml" title="RSS" href="https://kitere.github.io/feed.xml" />
<script type="text/javascript" src="../js/syntax_hl/shCore.js"></script>
<script type="text/javascript" src="../js/syntax_hl/shBrushAsm.js"></script>
<script type="text/javascript" src="../js/syntax_hl/shBrushCpp.js"></script>
<script type="text/javascript" src="../js/syntax_hl/shBrushPython.js"></script>
<link type="text/css" rel="stylesheet" href="../shCoreEkBox.css"/>
<script type="text/javascript">SyntaxHighlighter.defaults['toolbar'] = false;</script>
<script type="text/javascript">SyntaxHighlighter.all();</script>
</head>
<body>
        <div id="wrapper">
            <div id="header">
                <h1>EreTIk's Box</h1>
                <h2>Разработка, исследование и низкоуровневое программирование</h2>
            </div>
        <div id="strap">
<b>EreTIk's Box </b> &raquo; <a href="../Articles.html">Cтатьи, исходники</a> &raquo; Рассылка IRP о завершении работы системы (IRP_MJ_SHUTDOWN)
        </div>
<br /><table align="center" border="0" cellpadding="0" cellspacing="0" width="98%"><tr valign="top"><td>
        <div id="navigation">
            <ul id="menu">
                <li><a href="../index.htm">Стартовая страница</a></li>
                <li><a href="../Articles.html">Cтатьи, исходники</a></li>
                <li><a href="../WinDbg.html">Заметки о WinDbg</a></li>
                <li><a href="../Downloads.html">Скачать</a></li>
                <li><a href="../Links.html">Внешние ссылки</a></li>
                <li><a href="../Overview.html">Обо всем</a></li>
                <li><a href="../Contacts.html">Контакты</a></li>
                <li><a href="../Tools.html" onmouseover="mopen('m_tools')" onmouseout="mclosetime()">Утилиты</a>
                  <script type="text/javascript">
                  <!--
                    nav_tools("../");
                  // -->
                  </script>
                </li>
            </ul>
        </div>
        <div style="clear:both"></div>
</td><td>
        <div id="content">
            <br />
                <p>
Отлаживал рассылку IO-менеджером IRP_MJ_SHUTDOWN, в процессе набросал 
несколько скриптов для перечисления зарегистрированных устройств. Для работы 
скриптов потребуется <a target="_blank" href="https://pykd.codeplex.com/">pykd</a>.
Результаты работы скриптов сняты с Windows 10 AMD64 (build 10240), 
<a target="_blank" href="https://pykd.codeplex.com/releases/view/620817">pykd 0.3.1.1</a>.
                </p>
            <br />
                <p>
Получение устройств, зарегистрированных вызовом 
<a target="_blank" href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff549541(v=vs.85).aspx">IoRegisterShutdownNotification(...)</a>:
                </p>
            <br />
                <pre class="brush: py;">
&gt;&gt;&gt; nt = module(&quot;nt&quot;)
&gt;&gt;&gt; ti = createStruct(&quot;SHUTDOWN_PACKET&quot;)
&gt;&gt;&gt; ti.append(&quot;ListEntry&quot;, nt.type(&quot;_LIST_ENTRY&quot;))
&gt;&gt;&gt; ti.append(&quot;DeviceObject&quot;, nt.type(&quot;_DEVICE_OBJECT&quot;).ptrTo())
&gt;&gt;&gt; for i in typedVarList( nt.IopNotifyShutdownQueueHead, ti, &quot;ListEntry&quot; ):
...   print( dbgCommand(&quot;!devobj 0x{:x}&quot;.format(int(i.DeviceObject))) )
...
                </pre>
                <div class="code">
Device object (ffffe001e1863050) is for:
 0000001b \Driver\usbhub DriverObject ffffe001e17a02d0
Current Irp 00000000 RefCount 0 Type 00008600 Flags 00002840
Dacl ffffc10226788f51 DevExt ffffe001e18631a0 DevObjExt ffffe001e1866640 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000080)  FILE_AUTOGENERATED_DEVICE_NAME
AttachedTo (Lower) ffffe001e1726050 \Driver\usbohci
Device queue is not busy.

Device object (ffffe001e15e1610) is for:
 ahcache \Driver\ahcache DriverObject ffffe001e15ef060
Current Irp 00000000 RefCount 1 Type 00000022 Flags 00000840
Dacl ffffc10226788f51 DevExt 00000000 DevObjExt ffffe001e15e1760 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000100)  FILE_DEVICE_SECURE_OPEN
Device queue is not busy.

Device object (ffffe001e14de030) is for:
  \Driver\CSC DriverObject ffffe001e15f23c0
Current Irp 00000000 RefCount 0 Type 00000014 Flags 00000800
Dacl ffffc1022691f010 DevExt ffffe001e14de180 DevObjExt ffffe001e14df300 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000010)  FILE_REMOTE_DEVICE
Device queue is not busy.

Device object (ffffe001e1361e40) is for:
 KsecDD \Driver\KSecDD DriverObject ffffe001e1367a70
Current Irp 00000000 RefCount 43 Type 00000039 Flags 00000840
Dacl ffffc102267d6171 DevExt 00000000 DevObjExt ffffe001e1361f90 
ExtensionFlags (0000000000)  
Characteristics (0x00000100)  FILE_DEVICE_SECURE_OPEN
Device queue is not busy.

Device object (ffffe001e1307060) is for:
 MountPointManager \Driver\mountmgr DriverObject ffffe001e1308790
Current Irp 00000000 RefCount 0 Type 00000012 Flags 00000840
Dacl ffffc1022691f010 DevExt ffffe001e13071b0 DevObjExt ffffe001e1307320 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000100)  FILE_DEVICE_SECURE_OPEN
Device queue is not busy.

Device object (ffffe001e1313a00) is for:
 RawTape \FileSystem\RAW DriverObject ffffe001e131a8a0
Current Irp 00000000 RefCount 1 Type 00000020 Flags 00000850
Dacl ffffc1022691f010 DevExt 00000000 DevObjExt ffffe001e1313b50 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
Device queue is not busy.

Device object (ffffe001e03f5500) is for:
 WMIDataDevice \Driver\WMIxWDM DriverObject ffffe001e02a2b30
Current Irp 00000000 RefCount 8 Type 00000022 Flags 00000840
Dacl ffffc10226788f51 DevExt 00000000 DevObjExt ffffe001e03f5650 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000100)  FILE_DEVICE_SECURE_OPEN
Device queue is not busy.

                </div>
            <br />
                <p>
Если IopNotifyShutdownQueueHead заменить на IopNotifyLastChanceShutdownQueueHead, 
то получим устройства, зарегистрированные вызовом 
<a target="_blank" href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff549518(v=vs.85).aspx">IoRegisterLastChanceShutdownNotification(...)</a>:
                </p>
            <br />
                <div class="code">
Device object (ffffe001e1308060) is for:
 VolMgrControl \Driver\volmgr DriverObject ffffe001e1309610
Current Irp 00000000 RefCount 0 Type 00000012 Flags 00000840
Dacl ffffc1022691f010 DevExt ffffe001e13081b0 DevObjExt ffffe001e1308340 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000100)  FILE_DEVICE_SECURE_OPEN
AttachedTo (Lower) ffffe001e03fbe40 \Driver\PnpManager
Device queue is not busy.

Device object (ffffe001e130a3b0) is for:
 Spaceport \Driver\spaceport DriverObject ffffe001e02426e0
Current Irp 00000000 RefCount 0 Type 00000004 Flags 00002840
Dacl ffffc10226788f51 DevExt ffffe001e130a500 DevObjExt ffffe001e130aec8 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000100)  FILE_DEVICE_SECURE_OPEN
AttachedTo (Lower) ffffe001e03f8660 \Driver\PnpManager
Device queue is not busy.
                </div>
            <br />
                <p>
Кроме этого, IRP_MJ_SHUTDOWN (без дополнительной регистрации) получают драйвера 
файловый систем, зарегистрированные вызовом 
<a target="_blank" href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff548494(v=vs.85).aspx">IoRegisterFileSystem(...)</a>
 (три списка, в зависимости от типа устройства):
                </p>
            <br />
                <pre class="brush: py;">
&gt;&gt;&gt; nt = module(&quot;nt&quot;)
&gt;&gt;&gt; for i in typedVarList( nt.IopDiskFileSystemQueueHead, nt.type(&quot;_DEVICE_OBJECT&quot;), &quot;Queue.ListEntry&quot; ):
...   print( dbgCommand(&quot;!devobj 0x{:x}&quot;.format(int(i))) )
... 
                </pre>
                <div class="code">
Device object (ffffe001e16ce480) is for:
 Fat \FileSystem\fastfat DriverObject ffffe001e14dfe60
Current Irp 00000000 RefCount 1 Type 00000008 Flags 00000040
Dacl ffffc1022691f010 DevExt 00000000 DevObjExt ffffe001e16ce5d0 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
AttachedDevice (Upper) ffffe001e1784dc0 \FileSystem\FltMgr
Device queue is not busy.

Device object (ffffe001e135ce40) is for:
 Ntfs \FileSystem\NTFS DriverObject ffffe001e13616d0
Current Irp 00000000 RefCount 1 Type 00000008 Flags 08000040
Dacl ffffc1022691f010 DevExt 00000000 DevObjExt ffffe001e135cf90 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
AttachedDevice (Upper) ffffe001e1364580 \FileSystem\FltMgr
Device queue is not busy.

Device object (ffffe001e1366e30) is for:
 ExFatRecognizer \FileSystem\Fs_Rec DriverObject ffffe001e135dda0
Current Irp 00000000 RefCount 1 Type 00000008 Flags 00010040
Dacl ffffc1022691f010 DevExt ffffe001e1366f80 DevObjExt ffffe001e1366f90 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
Device queue is not busy.

Device object (ffffe001e1366c00) is for:
 ReFSRecognizer \FileSystem\Fs_Rec DriverObject ffffe001e135dda0
Current Irp 00000000 RefCount 1 Type 00000008 Flags 00010040
Dacl ffffc1022691f010 DevExt ffffe001e1366d50 DevObjExt ffffe001e1366d60 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
Device queue is not busy.

Device object (ffffe001e13669d0) is for:
 ReFSv1Recognizer \FileSystem\Fs_Rec DriverObject ffffe001e135dda0
Current Irp 00000000 RefCount 1 Type 00000008 Flags 00010040
Dacl ffffc1022691f010 DevExt ffffe001e1366b20 DevObjExt ffffe001e1366b30 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
Device queue is not busy.

Device object (ffffe001e135c060) is for:
 UdfsDiskRecognizer \FileSystem\Fs_Rec DriverObject ffffe001e135dda0
Current Irp 00000000 RefCount 1 Type 00000008 Flags 00010040
Dacl ffffc1022691f010 DevExt ffffe001e135c1b0 DevObjExt ffffe001e135c1c0 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
Device queue is not busy.

Device object (ffffe001e1313e40) is for:
 RawDisk \FileSystem\RAW DriverObject ffffe001e131a8a0
Current Irp 00000000 RefCount 1 Type 00000008 Flags 00000050
Dacl ffffc1022691f010 DevExt 00000000 DevObjExt ffffe001e1313f90 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
AttachedDevice (Upper) ffffe001e136cb30 \FileSystem\FltMgr
Device queue is not busy.

                </div>
                <pre class="brush: py;">
&gt;&gt;&gt; nt = module(&quot;nt&quot;)
&gt;&gt;&gt; for i in typedVarList(nt.IopCdRomFileSystemQueueHead, nt.type(&quot;_DEVICE_OBJECT&quot;), &quot;Queue.ListEntry&quot; ):
...   print( dbgCommand(&quot;!devobj 0x{:x}&quot;.format(int(i))) )
...
                </pre>
                <div class="code">
Device object (ffffe001e14cfe40) is for:
 FatCdrom \FileSystem\fastfat DriverObject ffffe001e14dfe60
Current Irp 00000000 RefCount 1 Type 00000003 Flags 00000040
Dacl ffffc1022691f010 DevExt 00000000 DevObjExt ffffe001e14cff90 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
AttachedDevice (Upper) ffffe001e17d7870 \FileSystem\FltMgr
Device queue is not busy.

Device object (ffffe001e135c3a0) is for:
 UdfsCdRomRecognizer \FileSystem\Fs_Rec DriverObject ffffe001e135dda0
Current Irp 00000000 RefCount 1 Type 00000003 Flags 00000040
Dacl ffffc1022691f010 DevExt ffffe001e135c4f0 DevObjExt ffffe001e135c500 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
Device queue is not busy.

Device object (ffffe001e135d060) is for:
 CdfsRecognizer \FileSystem\Fs_Rec DriverObject ffffe001e135dda0
Current Irp 00000000 RefCount 1 Type 00000003 Flags 00010040
Dacl ffffc1022691f010 DevExt ffffe001e135d1b0 DevObjExt ffffe001e135d1c0 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
Device queue is not busy.

Device object (ffffe001e1313c20) is for:
 RawCdRom \FileSystem\RAW DriverObject ffffe001e131a8a0
Current Irp 00000000 RefCount 1 Type 00000003 Flags 00000050
Dacl ffffc1022691f010 DevExt 00000000 DevObjExt ffffe001e1313d70 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
AttachedDevice (Upper) ffffe001e136b040 \FileSystem\FltMgr
Device queue is not busy.

                </div>
                <pre class="brush: py;">
&gt;&gt;&gt; nt = module(&quot;nt&quot;)
&gt;&gt;&gt; for i in typedVarList( nt.IopTapeFileSystemQueueHead, nt.type(&quot;_DEVICE_OBJECT&quot;), &quot;Queue.ListEntry&quot; ):
...   print( dbgCommand(&quot;!devobj 0x{:x}&quot;.format(int(i))) )
...
                </pre>
                <div class="code">
Device object (ffffe001e1313a00) is for:
 RawTape \FileSystem\RAW DriverObject ffffe001e131a8a0
Current Irp 00000000 RefCount 1 Type 00000020 Flags 00000850
Dacl ffffc1022691f010 DevExt 00000000 DevObjExt ffffe001e1313b50 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0000000000)  
Device queue is not busy.
                </div>
            <br />
                <p>
Очередность рассылки IRP IO-менеджером:
                </p>
                <ol type="1">
<li>Устройства, зарегистрированные вызовом <a target="_blank" href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff549541(v=vs.85).aspx">IoRegisterShutdownNotification(...)</a></li>
<li>Устройства из списка IopDiskFileSystemQueueHead</li>
<li>Устройства из списка IopCdRomFileSystemQueueHead</li>
<li>Устройства из списка IopTapeFileSystemQueueHead</li>
<li>Устройства, зарегистрированные вызовом <a target="_blank" href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff549518(v=vs.85).aspx">IoRegisterLastChanceShutdownNotification(...)</a></li>
                </ol>
                <p>
Между пунктами 1 и 2 происходит вызов функции nt!CmShutdownSystem(), которая в 
конце взводит признак HvShutdownComplete в TRUE. А, опираясь на взведенный 
признак HvShutdownComplete, многие реестровые функции возвращают <b>STATUS_TOO_LATE</b>.
                </p>
<br /><p align="right"><font size="+1">&#x39E;&#x3C1;&#x3B5;&#x3A4;&#x399;&#x3BA;</font></p>
        </div>
</td></tr></table>
    </div>
<div>
<!--Openstat-->
<span id="openstat2069613"></span><script type="text/javascript"> var openstat = { counter: 2069613, image: 37, next: openstat , track_links: "all" }; document.write(unescape("%3Cscript%20src=%22http" +
(("https:" == document.location.protocol) ? "s" : "") +
"://openstat.net/cnt.js%22%20defer=%22defer%22%3E%3C/script%3E")); </script>
<!--Openstat-->
</div>

</body>
</html>
